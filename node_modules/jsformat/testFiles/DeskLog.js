initialize.set('DeskLog', function () {

    $contentLoadTriggered = false;
    var currentPage = 0;
    var currentPagedeal = 0;

    $(document).ready(function () {
        $('#Withdeal_IdCounter').val($('#currentIndex').val());
    });

    $('#middle_desk_withoutdeal').hide();
    $('#middle_desk_withdeal').show();
    $('#DeskLogID_withdeal').show();
    $('#DeskLogID_withdeal_table').hide();
    $('#DeskLogID_withdeal_noresult').hide();
    $('#DeskLogID_table').hide();
    $('#DeskLogID_noresult').hide();
    $('#DeskLogID_items').hide();
    $('#DeskLogID_withdeal_items').hide();
    $(':radio[value=with_deal]').attr('checked', true);

    if ($(':radio[name=deal]:checked').val() == 'with_deal') {
        getSearchListOnLoad($('#HiddenSortField').val(), $('#HiddenSortOrder').val());
    }
    
    $("#DN1").on("click", function (e) {
        if (e.handled === true)
            return false;
        e.handled = true;
        SortOrder('DeskNameDeal');
    });

    $("#CM1").on("click", function (e) {
        if (e.handled === true)
            return false;
        e.handled = true;
        SortOrder('CustomerDeal');
    });

    $("#ST1").on("click", function (e) {
        if (e.handled === true)
            return false;
        e.handled = true;
        SortOrder('StatusDeal');
    });

    $("#DN2").on("click", function (e) {
        if (e.handled === true)
            return false;
        e.handled = true;
        SortOrder('DealNumberDeal');
    });

    $("#FT1").on("click", function (e) {
        if (e.handled === true)
            return false;
        e.handled = true;
        SortOrder('FinancetypeDeal');
    });

    $("#ASSN1").on("click", function (e) {
        if (e.handled === true)
            return false;
        e.handled = true;
        SortOrder('AssignedToDeal');
    });

    $("#SD1").on("click", function (e) {
        if (e.handled === true)
            return false;
        e.handled = true;
        SortOrder('StatusDateDeal');
    });

    $("#MK1").on("click", function (e) {
        if (e.handled === true)
            return false;
        e.handled = true;
        SortOrder('MakeDeal');
    });

    $("#ML1").on("click", function (e) {
        if (e.handled === true)
            return false;
        e.handled = true;
        SortOrder('ModelDeal');
    });

    $("#TR1").on("click", function (e) {
        if (e.handled === true)
            return false;
        e.handled = true;
        SortOrder('TrimDeal');
    });

    $("#YR1").on("click", function (e) {
        if (e.handled === true)
            return false;
        e.handled = true;
        SortOrder('YearDeal');
    });

    $("#DN").on("click", function (e) {
        if (e.handled === true)
            return false;
        e.handled = true;
        SortOrder('DeskName');

    });

    $("#CM").on("click", function (e) {
        if (e.handled === true)
            return false;
        e.handled = true;
        SortOrder('Customer');
    });

    $("#ST").on("click", function (e) {
        if (e.handled === true)
            return false;
        e.handled = true;
        SortOrder('Status');

    });

    $("#ASSN").on("click", function (e) {
        if (e.handled === true)
            return false;
        e.handled = true;
        SortOrder('AssignedTo');

    });

    $("#fromdate_withdeal").on("change", function (e) {
        if (DateValidation(this) == false) {
            $('.ErrorDiv').empty();
            $(this).after("<div class='ErrorDiv' style='position:absolute; border:1px solid red; left:58%; background:#f2f2f2; padding:5px 20px; color:red;'>Invalid date.</div>");
            $(this).addClass('error');
            $('.ErrorDiv').animate({
                opacity: 1
            }, 2000, function () {
                $('.ErrorDiv').fadeOut(1000);
                $(this).focus();
                $('input, select').removeClass('error');
            });
            return;
        }
    });

    $("#todate_withdeal").on("change", function (e) {
        if (DateValidation(this) == false) {
            $('.ErrorDiv').empty();
            $(this).after("<div class='ErrorDiv' style='position:absolute; border:1px solid red; background:#f2f2f2; left:72%; padding:5px 20px; color:red;'>Invalid date.</div>");
            $(this).addClass('error');
            $('.ErrorDiv').animate({
                opacity: 1
            }, 2000, function () {
                $('.ErrorDiv').fadeOut(1000);
                $(this).focus();
                $('input, select').removeClass('error');
            });
            return;
        }
    });

    $("#fromdate").on("change", function (e) {
        if (DateValidation(this) == false) {
            $('.ErrorDiv').empty();
            $(this).after("<div class='ErrorDiv' style='position:absolute; border:1px solid red; background:#f2f2f2; left:44.5%; padding:5px 20px; color:red;'>Invalid date.</div>");
            $(this).addClass('error');
            $('.ErrorDiv').animate({
                opacity: 1
            }, 2000, function () {
                $('.ErrorDiv').fadeOut(1000);
                $(this).focus();
                $('input, select').removeClass('error');
            });
            return;
        }
    });

    $("#todate").on("change", function (e) {
        if (DateValidation(this) == false) {
            $('.ErrorDiv').empty();
            $(this).after("<div class='ErrorDiv' style='position:absolute; border:1px solid red; background:#f2f2f2; left:58.5%; padding:5px 20px; color:red;'>Invalid date.</div>");
            $(this).addClass('error');
            $('.ErrorDiv').animate({
                opacity: 1
            }, 2000, function () {
                $('.ErrorDiv').fadeOut(1000);
                $(this).focus();
                $('input, select').removeClass('error');
            });
            return;
        }
    });

    $("#SD").on("click", function (e) {
        if (e.handled === true)
            return false;
        e.handled = true;
        SortOrder('StatusDate');
    });

    $(':radio[name=deal]').on('change', function () {
        var deal_type = $(':radio[name=deal]:checked').val();
        ClearAll();
        if (deal_type == 'with_deal') {
            $('#middle_desk_withdeal').show();
            $('#DeskLogID_withdeal').show();
            $('#Deskname_withdeal').val('');
            $('#middle_desk_withoutdeal').hide();
            $('#DeskLogID').hide();
            var from_dateVal = $("#fromdate_withdeal").val();
            var to_dateVal = $("#todate_withdeal").val();
            if ((from_dateVal == '') || (to_dateVal == ''))
                return false;
        }
        if (deal_type == 'without_deal') {
            $('#middle_desk_withdeal').hide();
            $('#DeskLogID_withdeal').hide();
            $('#Deskname_withoutdeal').val("");
            $('#middle_desk_withoutdeal').show();
            $('#DeskLogID').show();
            var from_dateVal = $("#fromdate").val();
            var to_dateVal = $("#todate").val();
            if ((from_dateVal == '') || (to_dateVal == ''))
                return false;
        }
        getSearchListOnLoad("", "");
    });

    $('#todate').on('change', function (e) {
        var selectedDate = new Date($(this).val());
        var fromdate = $("#fromdate").val();
        var dtfromdate = new Date(fromdate);
        if (selectedDate < dtfromdate) {
            $("#todate").val('');
            ShowAlertMessage("'To Date' must be greater than 'From Date'.");
            //showMessage('message', 'Desk Log', "'To Date' must be greater than 'From Date'.");
        }
    });

    $('#todate_withdeal').on('change', function (e) {
        var todate = $(this).val();
        var fromdate = $("#fromdate_withdeal").val();
        var dtfromdate = new Date(fromdate);
        var dttodate = new Date(todate);
        if (dttodate < dtfromdate) {
            $("#todate_withdeal").val('');
            //showMessage('message', 'Desk Log', "'To Date' must be greater than 'From Date'.");
            ShowAlertMessage("'To Date' must be greater than 'From Date'.");
        }
    });

    $("#DealNo_withdeal").bind('keydown', function (e) {
        check_digits(e);
    });

    $("#DDLAssignedTo_withdeal").autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "./../ViewDeskLog/FetchCustomer", type: "POST", dataType: "json",
                data: { searchText: request.term },
                success: function (data) {
                    response($.map(data, function (CusDetails) {
                        $('#AssignedToId').val('0');
                        return { label: CusDetails.firstname, value: CusDetails.firstname, id: CusDetails.customerid };
                    }));
                } //success
            }); //$.ajax
        }, //source:
        select: function (event, ui) {
            $('#AssignedToId').val(ui.item.id);
        } //select:
    });

    $("#DDLAssignedTo").autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "./../ViewDeskLog/FetchCustomer", type: "POST", dataType: "json",
                data: { searchText: request.term },
                success: function (data) {
                    response($.map(data, function (CusDetails) {
                        $('#AssignedToId_withoutdeal').val('0');
                        return { label: CusDetails.firstname, value: CusDetails.firstname, id: CusDetails.customerid };
                    }));
                } //success
            }); //$.ajax
        }, //source:
        select: function (event, ui) {
            $('#AssignedToId_withoutdeal').val(ui.item.id);
        }
    });

    $("#DDLFnIAssociate_withdeal").autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "./../ViewDeskLog/FetchAssociates", type: "POST", dataType: "json",
                data: { searchText: request.term },
                success: function (data) {
                    response($.map(data, function (associates) {
                        //  $('#HiddenAssociateId').val('0');
                        return { label: associates.empname, value: associates.empname, id: associates.empid };
                    }));
                }, //source:
                select: function (event, ui) {
                    //  $('#HiddenAssociateId').val(ui.item.id);
                } //select:
            }); //$.ajax
        } //source:
    });

    $("#DDLFnIAssociate").autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "./../ViewDeskLog/FetchAssociates", type: "POST", dataType: "json",
                data: { searchText: request.term },
                success: function (data) {
                    response($.map(data, function (associates) {
                        return { label: associates.empname, value: associates.empname, id: associates.empid };
                    }));
                } //success
            }); //$.ajax
        } //source:
    });

    $("#DDLSalesPerson_withdeal").autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "./../ViewDeskLog/FetchSalesAssociates", type: "POST", dataType: "json",
                data: { searchText: request.term },
                success: function (data) {
                    response($.map(data, function (salesassociates) {
                        return { label: salesassociates.empname, value: salesassociates.empname, id: salesassociates.empid };
                    }));
                } //success
            }); //$.ajax
        } //source:
    });

    $("#DDLSalesPerson").autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "./../ViewDeskLog/FetchSalesAssociates", type: "POST", dataType: "json",
                data: { searchText: request.term },
                success: function (data) {
                    response($.map(data, function (salesassociates) {
                        return { label: salesassociates.empname, value: salesassociates.empname, id: salesassociates.empid };
                    }));
                } //success
            }); //$.ajax
        } //source:
    });

    $("#SearchBtn").on('click', function (event) {
        $('#Withdeal_IdCounter').val('');
        $('#HiddenSortField').val('');
        $('#HiddenSortOrder').val('');
        getSearchListOnLoad($('#HiddenSortField').val(), $('#HiddenSortOrder').val());
    });


});

function ClearAll() {
    $('#Withdeal_IdCounter').val('');
    $('#HiddenSortField').val('');
    $('#HiddenSortOrder').val('');
    $('#DealNo_withdeal').val('');
    $('#CustomerTbx_withdeal').val('');
    $('#DeskName_withdeal').val('');
    $("#DDLDeskStatus_withdeal")[0].selectedIndex = 0;
    $('#DDLAssignedTo_withdeal').val('');
    $('#DDLFnIAssociate_withdeal').val('');
    $('#DDLSalesPerson_withdeal').val('');
    $('#tbxStockNumber').val('');
    $("#DDLFinanceTypes")[0].selectedIndex = 0;
    $("#DDLDeskStatus")[0].selectedIndex = 0;
    $('#CustomerTbx').val('');
    $('#DeskName_withoutdeal').val('');
    $('#DDLAssignedTo').val('');
    $('#DDLFnIAssociate').val('');
    $('#DDLSalesPerson').val('');
    $("#fromdate_withdeal").val($('#HiddenFromDate').val());
    $("#todate_withdeal").val($('#HiddenToDate').val());
    $("#fromdate").val($('#HiddenFromDateWithtDeal').val());
    $("#todate").val($('#HiddenToDateWithtDeal').val());

}

function getSearchListOnLoad(SortFieldName, SortOrders) {
    $('#validationmessage_withoutdeal').empty();
    $('#validationmessage_withdeal').empty();
    var deskstatus = "";
    var deskid = $("#DDLDeskStatus_withdeal").val();
    var deal_type = $(':radio[name=deal]:checked').val();
    if (deal_type == 'with_deal') {
        deskstatus = $('#DDLDeskStatus_withdeal').find('option:selected').text();
        var fromdate = $("#fromdate_withdeal").val();
        var dtfromdate = new Date(fromdate);
        var todate = $("#todate_withdeal").val();
        var dttodate = new Date(todate);
        if (dttodate < dtfromdate) {
            //showMessage('message', 'Desk Log', "'To Date' must be greater than 'From Date'.");
            ShowAlertMessage("'To Date' must be greater than 'From Date'.");
            $("#todate_withdeal").val('');
            $("#alertHidden").val('#todate_withdeal');
            return false;
        }
        var assign = $("#DDLAssignedTo_withdeal").val();
        if (assign == '' || $.trim(assign) == '')
            $('#AssignedToId').val('0');
        var customername = $("#CustomerTbx_withdeal").val();
        var from_dateVal = $("#fromdate_withdeal").val();
        var to_dateVal = $("#todate_withdeal").val();
        var FnIAssociate = $("#DDLFnIAssociate_withdeal").val();
        var AssignedTo = $('#AssignedToId').val();
        var AssignedToText = $("#DDLAssignedTo_withdeal").val();
        var SalesPerson = $("#DDLSalesPerson_withdeal").val();
        var stockNumber = $('#tbxStockNumber').val();
        var dealnumber = $("#DealNo_withdeal").val();
        var fintype = $("#DDLFinanceTypes").val();
        var deskname = $("#DeskName_withdeal").val();
        if (customername == '' && deskstatus == '' && (from_dateVal == '' || to_dateVal == '')) {
            $('#validationmessage_withdeal').html("No values are specified.");
            return false;
        }
    }
    if (deal_type == 'without_deal') {
        $('#Withdeal_IdCounter').val('');
        var fromdate = $("#fromdate").val();
        var dtfromdate = new Date(fromdate);
        var todate = $("#todate").val();
        var dttodate = new Date(todate);
        if (dttodate < dtfromdate) {
            //showMessage('message', 'Desk Log', "'To Date' must be greater than 'From Date'.");
            ShowAlertMessage("'To Date' must be greater than 'From Date'.");
            $("#todate").val('');
            $("#alertHidden").val('#todate');
            return false;
        }
        var assign = $("#DDLAssignedTo").val();
        if (assign == '' || $.trim(assign) == '')
            $('#AssignedToId_withoutdeal').val('0');
        var customername = $("#CustomerTbx").val();
        deskstatus = $("#DDLDeskStatus").val();
        var from_dateVal = $("#fromdate").val();
        var to_dateVal = $("#todate").val();
        var FnIAssociate = $("#DDLFnIAssociate").val();
        var AssignedTo = $("#AssignedToId_withoutdeal").val();
        var AssignedToText = $("#DDLAssignedTo").val();
        var SalesPerson = $("#DDLSalesPerson").val();
        //var stockNumber = $('#tbxStockNumber').val();
        var fintype = $("#DDLFinanceTypes_nodeal").val();
        var deskname = $("#DeskName_withoutdeal").val();
        if (customername == '' && deskstatus == '' && (from_dateVal == '' || to_dateVal == '')) {
            $('#validationmessage_withoutdeal').html("No values are specified.");
            return false;
        }
    }
    var URL = './../ViewDeskLog/DeskLog_Search_WithDeal';
    $.ajax({
        type: 'Post',
        url: URL,
        data: {
            dealtype: deal_type,
            custname: customername,
            deskid: deskid,
            from_date: from_dateVal,
            to_date: to_dateVal,
            FnIAssociate: FnIAssociate,
            AssignedTo: AssignedTo,
            AssignedToText: AssignedToText,
            SalesPerson: SalesPerson,
            StockNumber: stockNumber,
            dealnumber: dealnumber,
            fintype: fintype,
            Deskname: deskname,
            seldeskstatus: deskstatus,
            currentpage: "0",
            seldeskstatus: deskstatus,
            sortField: SortFieldName,
            sortOrder: SortOrders,
            CurrentIndex: $('#Withdeal_IdCounter').val()

        },
        beforeSend: function () {
            $('#loader').show();
            $('#DesksInProgress').show();
        },
        success: function (result) {
            $('#loader').hide();
            $('#DesksInProgress').hide();
            if (deal_type == 'with_deal') {
                if (result.length > 142) {
                    $("#DeskLogID_withdeal_details").empty();
                    $("#DeskLogID_withdeal_details").html(result);
                    $('#CheckCountWithDeal').val('0');
                    $('#CheckCountWithOutDeal').val('0');
                    $('#DeskLogID_withdeal_items').show();
                    $('#DeskLogID_withdeal_table').show();
                    $('#DeskLogID_withdeal_noresult').hide();
                    $('#DeskLogID_table').hide();
                    $('#DeskLogID_noresult').hide();
                    $('#DeskLogID_items').hide();
                }
                else {
                    $("#DeskLogID_withdeal_details").empty();
                    $('#DeskLogID_withdeal_items').show();
                    $('#DeskLogID_withdeal_table').hide();
                    $('#DeskLogID_withdeal_noresult').show();
                    $('#DeskLogID_table').hide();
                    $('#DeskLogID_noresult').hide();
                    $('#DeskLogID_items').hide();
                }
            }
            else {
                if (result.length > 6) {
                    $("#DeskLogID_details").empty();
                    $("#DeskLogID_details").html(result);
                    $('#CheckCountWithDeal').val('0');
                    $('#CheckCountWithOutDeal').val('0');
                    $('#DeskLogID_withdeal_items').hide();
                    $('#DeskLogID_withdeal_table').hide();
                    $('#DeskLogID_withdeal_noresult').hide();
                    $('#DeskLogID_items').show();
                    $('#DeskLogID_table').show();
                    $('#DeskLogID_noresult').hide();
                }
                else {
                    $("#DeskLogID_details").empty();
                    $('#DeskLogID_withdeal_items').hide();
                    $('#DeskLogID_withdeal_table').hide();
                    $('#DeskLogID_withdeal_noresult').hide();
                    $('#DeskLogID_items').show();
                    $('#DeskLogID_table').hide();
                    $('#DeskLogID_noresult').show();
                }
            }


            $(".withdeal").on("change", function () {
                var row = $(this).closest('tr');
                var prevValue = row.find('#HiddenAssignedWithDeal').val();
                var DeskId = row.find('#HiddenDeskId_withdeal').val();
                if ($(this).val() == '') {
                    //showMessage('message', 'Desk Log', 'Invalid Name. Please try again.');
                    ShowAlertMessage('Invalid Name. Please try again.');
                    row.find('#textBoxAssignedTo_withdeal' + DeskId).val(prevValue);
                    $('input').removeClass('ui-autocomplete-loading');
                    return;
                }
            });

            $(".withdeal").on("focus", function () {
                var row = $(this).closest('tr');
                var prevValue = row.find('#HiddenAssignedWithDeal').val();
                var DeskId = row.find('#HiddenDeskId_withdeal').val();
                $(this).autocomplete({//autocomplete start
                    minLength: 0,
                    delay: 0,
                    source: function (request, response) {//source function start
                        $.ajax({
                            url: "./../ViewDeskLog/FetchCustomer", type: "POST", dataType: "json",
                            data: { searchText: request.term },
                            success: function (data) {
                                if (data.Msg == "Failed") {
                                    //showMessage('message', 'Desk Log', 'Invalid Name. Please try again.');
                                    ShowAlertMessage('Invalid Name. Please try again.');
                                    row.find('#textBoxAssignedTo_withdeal' + DeskId).val(prevValue);
                                    $('input').removeClass('ui-autocomplete-loading');
                                    return;
                                }
                                else {
                                    response($.map(data, function (CusDetails) {
                                        if (data.Msg == "Failed") {
                                            //showMessage('message', 'Desk Log', 'Invalid Name. Please try again.');
                                            ShowAlertMessage('Invalid Name. Please try again.');
                                            row.find('#textBoxAssignedTo_withdeal' + DeskId).val(prevValue);
                                            $('input').removeClass('ui-autocomplete-loading');
                                            return false;
                                        }
                                        else {
                                            return { label: CusDetails.firstname, value: CusDetails.firstname, id: CusDetails.customerid };
                                        }

                                    }));
                                }
                            } //success  
                        }); //$.ajax
                    }, //source funcion end
                    select: function (event, ui) {//select start

                        var row = $(this).closest('tr');
                        var DeskName = row.find('#HiddenDeskName_withdeal').val();
                        var DeskId = row.find('#HiddenDeskId_withdeal').val();
                        $.ajax({
                            url: "./../ViewDeskLog/UpdateCustomer", type: "POST", dataType: "json",
                            data: { newUserId: ui.item.id, DeskId: DeskId }
                        }); //aajx
                    } //select end
                }); //autocomplete end
            }); //function end

            $("#DeskLogID_withdeal_items").scroll(function () {
                if ($('#DeskLogID_withdeal_table').css("display") != "none") {
                    if ($("#DeskLogID_withdeal_items").scrollTop() >= ($("#DeskLogID_withdeal_details").height() - $("#DeskLogID_withdeal_items").height()) && $contentLoadTriggered == false) {
                        $contentLoadTriggered = true;
                        var count = $('#CheckCountWithDeal').val();
                        if (count == '0') {
                            currentPage = 1;
                            $('#CheckCountWithDeal').val('1');
                        }
                        else {
                            currentPage = currentPage + 1;
                        }
                        var deskid = $("#DDLDeskStatus_withdeal").val();
                        var deal_type = $(':radio[name=deal]:checked').val();
                        var fromdate = $("#fromdate_withdeal").val();
                        var dtfromdate = new Date(fromdate);
                        var todate = $("#todate_withdeal").val();
                        var dttodate = new Date(todate);
                        if (dttodate < dtfromdate) {
                            //showMessage('message', 'Desk Log', "'To Date' must be greater than 'From Date'.");
                            ShowAlertMessage("'To Date' must be greater than 'From Date'.");
                            $("#todate_withdeal").val('');
                            $("#alertHidden").val('#todate_withdeal');
                            return false;
                        }
                        var assign = $("#DDLAssignedTo_withdeal").val();
                        if (assign == '' || $.trim(assign) == '')
                            $('#AssignedToId').val('0');
                        var customername = $("#CustomerTbx_withdeal").val();
                        var deskstatus = $('#DDLDeskStatus_withdeal').find('option:selected').text();
                        var from_dateVal = $("#fromdate_withdeal").val();
                        var to_dateVal = $("#todate_withdeal").val();
                        var FnIAssociate = $("#DDLFnIAssociate_withdeal").val();
                        var AssignedTo = $('#AssignedToId').val();
                        var AssignedToText = $("#DDLAssignedTo_withdeal").val();
                        var SalesPerson = $("#DDLSalesPerson_withdeal").val();
                        var stockNumber = $('#tbxStockNumber').val();
                        var dealnumber = $("#DealNo_withdeal").val();
                        var fintype = $("#DDLFinanceTypes").val();
                        var deskname = $("#DeskName_withdeal").val();
                        if (customername == '' && deskstatus == '' && (from_dateVal == '' || to_dateVal == '')) {
                            $('#validationmessage_withdeal').html("No values are specified.");
                            return false;
                        }
                        var URL = './../ViewDeskLog/DeskLog_Search_WithDeal';
                        $.ajax({
                            type: 'Post',
                            url: URL,
                            data: {
                                dealtype: deal_type,
                                custname: customername,
                                deskid: deskid,
                                from_date: from_dateVal,
                                to_date: to_dateVal,
                                FnIAssociate: FnIAssociate,
                                AssignedTo: AssignedTo,
                                AssignedToText: AssignedToText,
                                SalesPerson: SalesPerson,
                                StockNumber: stockNumber,
                                dealnumber: dealnumber,
                                fintype: fintype,
                                Deskname: deskname,
                                seldeskstatus: deskstatus,
                                currentpage: currentPage,
                                sortField: $('#HiddenSortField').val(),
                                sortOrder: $('#HiddenSortOrder').val(),
                                CurrentIndex: $('#Withdeal_IdCounter').val()

                            },
                            beforeSend: function () {
                                $('#DesksInProgress').show();
                            },
                            success: function (model) {
                                $("#DeskLogID_withdeal_details").append(model);
                                $('#DeskLogID_withdeal_table').show();
                                $contentLoadTriggered = false;
                                $('#DesksInProgress').hide();
                            },
                            error: function (x, e) {
                                $('#DesksInProgress').hide();
                            }
                        });
                    }
                }
            });

            $("#DeskLogID_items").scroll(function () {
                if ($('#DeskLogID_table').css("display") != "none") {
                    if ($("#DeskLogID_items").scrollTop() >= ($("#DeskLogID_details").height() - $("#DeskLogID_items").height()) && $contentLoadTriggered == false) {
                        $contentLoadTriggered = true;
                        var count = $('#CheckCountWithOutDeal').val();
                        if (count == '0') {
                            currentPagedeal = 1;
                            $('#CheckCountWithOutDeal').val('1');
                        }
                        else {
                            currentPagedeal = currentPagedeal + 1;
                        }
                        var deskid = $("#DDLDeskStatus_withdeal").val();
                        var deal_type = $(':radio[name=deal]:checked').val();
                        var fromdate = $("#fromdate").val();
                        var dtfromdate = new Date(fromdate);
                        var todate = $("#todate").val();
                        var dttodate = new Date(todate);
                        if (dttodate < dtfromdate) {
                            //showMessage('message', 'Desk Log', "'To Date' must be greater than 'From Date'.");
                            ShowAlertMessage("'To Date' must be greater than 'From Date'.");
                            $("#todate").val('');
                            $("#alertHidden").val('#todate');
                            return false;
                        }
                        var assign = $("#DDLAssignedTo").val();
                        if (assign == '' || $.trim(assign) == '')
                            $('#AssignedToId_withoutdeal').val('0');
                        var customername = $("#CustomerTbx").val();
                        var deskstatus = $("#DDLDeskStatus").val();
                        var from_dateVal = $("#fromdate").val();
                        var to_dateVal = $("#todate").val();
                        var FnIAssociate = $("#DDLFnIAssociate").val();
                        var AssignedTo = $("#AssignedToId_withoutdeal").val();
                        AssignedToText = $("#DDLAssignedTo").val();
                        var SalesPerson = $("#DDLSalesPerson").val();
                        var stockNumber = "";
                        var dealnumber = "";
                        var fintype = $("#DDLFinanceTypes_nodeal").val();
                        var deskname = $("#DeskName_withoutdeal").val();
                        if (customername == '' && deskstatus == '' && (from_dateVal == '' || to_dateVal == '')) {
                            $('#validationmessage_withoutdeal').html("No values are specified.");
                            return false;
                        }
                        var URL = './../ViewDeskLog/DeskLog_Search_WithDeal';
                        $.ajax({
                            type: 'Post',
                            url: URL,
                            data: {
                                dealtype: deal_type,
                                custname: customername,
                                deskid: deskid,
                                from_date: from_dateVal,
                                to_date: to_dateVal,
                                FnIAssociate: FnIAssociate,
                                AssignedTo: AssignedTo,
                                AssignedToText: AssignedToText,
                                SalesPerson: SalesPerson,
                                StockNumber: stockNumber,
                                dealnumber: dealnumber,
                                fintype: fintype,
                                Deskname: deskname,
                                seldeskstatus: deskstatus,
                                currentpage: currentPagedeal,
                                sortField: $('#HiddenSortField').val(),
                                sortOrder: $('#HiddenSortOrder').val(),
                                CurrentIndex: $('#Withdeal_IdCounter').val()


                            },
                            beforeSend: function () {
                                $("#DesksInProgress").show();
                            },
                            success: function (model) {
                                $("#DeskLogID_details").append(model);
                                $('#DeskLogID_table').show();
                                $contentLoadTriggered = false;
                                $('#DesksInProgress').hide();

                            },
                            error: function (x, e) {
                                $('#DesksInProgress').hide();
                            }
                        });
                    }
                }
            });

            $('#DeskLogID_withdeal_table').find('td').on("click", function () {//click function start
                var $This = $(this);
                var col = $This.parent().children().index($(this));
                if (col != 7) {
                    $('#DesksInProgress').show();
                    var DeskId = $This.closest('tr').find('#HiddenDeskId_withdeal').val();
                    var ScenarioId = $This.closest('tr').find('#HiddenScenarioId_withdeal').val();
                    window.location.href = "./../Scenario/Index?DID=" + DeskId + "&SID=" + ScenarioId;
                } //if end
            }); //click function end

            $('#DeskLogID_table td').on("click", function () {
                var $This = $(this);
                var col = $This.parent().children().index($(this));
                if (col != 3) {
                    $('#DesksInProgress').show();
                    var DeskId = $This.closest('tr').find('#HiddenDID').val();
                    var ScenarioId = $This.closest('tr').find('#HiddenScenarioId').val();
                    window.location.href = "./../Scenario/Index?DID=" + DeskId + "&SID=" + ScenarioId;
                }
            });

            $(".noDealUserName").on("change", function () {
                var row = $(this).closest('tr');
                var prevValue = row.find('#HiddenAssignedWithoutDeal').val();
                var did = row.find('#HiddenDID').val();
                if ($(this).val() == '') {
                    //showMessage('message', 'Desk Log', 'Invalid Name. Please try again.');
                    ShowAlertMessage('Invalid Name. Please try again.');
                    row.find('#textBoxAssignedTo' + did).val(prevValue);
                    $('input').removeClass('ui-autocomplete-loading');
                    return false;
                }
            });

            $(".noDealUserName").on("focus", function () {
                var row = $(this).closest('tr');
                var prevValue = row.find('#HiddenAssignedWithoutDeal').val();
                var did = row.find('#HiddenDID').val();
                $(this).autocomplete({
                    minLength: 0,   //for local data
                    delay: 0,      //for local data
                    source: function (request, response) {
                        //var param= {"action":"getSalePoints"};
                        $.ajax({
                            url: "./../ViewDeskLog/FetchCustomer", type: "POST", dataType: "json",
                            data: { searchText: request.term },
                            success: function (data) {
                                if (data.Msg == "Failed") {
                                    //showMessage('message', 'Desk Log', 'Invalid Name. Please try again.');
                                    ShowAlertMessage('Invalid Name. Please try again.');
                                    row.find('#textBoxAssignedTo' + did).val(prevValue);
                                    $('input').removeClass('ui-autocomplete-loading');
                                    return false;
                                }
                                else {
                                    response($.map(data, function (CusDetails) {
                                        return { label: CusDetails.firstname, value: CusDetails.firstname, id: CusDetails.customerid };
                                    }));
                                }
                            } //success   
                        }); //$.ajax
                    },
                    select: function (event, ui) {
                        var btn = $(this);
                        var row = btn.closest('tr');
                        var DeskName = row.find('#HiddenDeskName').val();
                        var DeskId = row.find('#HiddenDID').val();
                        $.ajax({
                            url: "./../ViewDeskLog/UpdateUserIdInDeskTable", type: "POST", dataType: "json",
                            data: { newUserId: ui.item.id, oldUserId: DeskName, DeskId: DeskId }
                        });
                    }
                });
            });
        },
        error: function (error) {
            $('#loader').hide();
            $('#DesksInProgress').hide();
        }
    });
}

function CheckLenderType() {
    $('#DesksInProgress').show();
    var URL = './../ViewDeskLog/CheckLenderType';
    $.ajax({
        type: 'Post',
        url: URL,
        success: function (result) {
            if (result.Message == "SessionExpired") {
                $('#DesksInProgress').hide();
                //showMessage('message', 'Desk Log', "Session is expired, Please Login.");
                ShowAlertMessage("Session is expired, Please Login.");
                return;
            }
            else if (result.Message == "DBConnection") {
                $('#DesksInProgress').hide();
                ShowAlertMessage("Database connection Failed, Please Login or contact system administrator.");
                //showMessage('message', 'Desk Log', "Database connection Failed, Please Login or contact system administrator.");
                return;
            }

            if (result.Msg == "NoLenderType") {
                //showMessage('message', 'Desk Log', "Lender does not exist for Finance Type 'Finance'.");
                ShowAlertMessage("Lender does not exist for Finance Type 'Finance'.");
                return false;
            }
            if (result.Msg == "LenderExist") {
                var URL = './../Scenario/Index?Status=New';
                window.location.href = URL;
                return true;
            }

            $('#DesksInProgress').hide();
        },
        error: function (error) {
            $('#DesksInProgress').hide();
        }
    });
}

function SortOrder(sortcolumnname) {
    var sortorder = $('#HiddenSortOrder').val();
    (sortorder == '0') ? $('#HiddenSortOrder').val('1') : $('#HiddenSortOrder').val('0');
    $('#Withdeal_IdCounter').val('');
    getSearchListOnLoad(sortcolumnname, sortorder);
    $('#HiddenSortField').val(sortcolumnname);
}
